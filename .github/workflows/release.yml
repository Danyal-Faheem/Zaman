name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build app
        run: |
          xcodebuild -scheme Zaman -configuration Release -derivedDataPath build clean build

      - name: Create DMG
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg_temp

          # Copy the app to temp directory
          cp -R build/Build/Products/Release/Zaman.app dmg_temp/

          # Create Applications symlink for easy installation
          ln -s /Applications dmg_temp/Applications

          # Create DMG
          hdiutil create -volname "Zaman" -srcfolder dmg_temp -ov -format UDZO Zaman.dmg

      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(shasum -a 256 Zaman.dmg | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Zaman.dmg
          body: |
            ## Zaman ${{ github.ref_name }}

            Islamic prayer times in your macOS menu bar.

            ### Installation
            1. Download `Zaman.dmg`
            2. Open the DMG file
            3. Drag Zaman.app to Applications folder
            4. Launch Zaman from Applications

            ### SHA256
            ```
            ${{ steps.sha256.outputs.sha256 }}
            ```

            ### Features
            - ğŸ•Œ Menu bar prayer times
            - ğŸŒ 150+ cities worldwide
            - ğŸ“ Auto-detect location
            - ğŸ”” Adhan & Iqama notifications
            - ğŸŒ™ Hijri calendar
            - ğŸŒ“ Light & dark mode support
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
